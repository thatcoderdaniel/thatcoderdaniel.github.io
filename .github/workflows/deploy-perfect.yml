name: Perfect Jekyll Deploy to GCP

on:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [tinacms-update]
  workflow_dispatch:  # Manual trigger

env:
  GCP_PROJECT_ID: dmisblogging-prod
  GCS_BUCKET: blog.itsdanmanole.com
  CDN_LB_NAME: blog-lb
  RUBY_VERSION: '3.2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’ Setup Ruby with caching
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.0'
        bundler-cache: false
        
    - name: ğŸ”§ Install compatible bundler
      run: |
        gem install bundler -v '2.7.1'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        bundle install --jobs 4 --retry 3
        
    - name: ğŸ—ï¸ Build Jekyll site
      run: |
        echo "Building with optimized settings..."
        JEKYLL_ENV=production bundle exec jekyll build --config _config.yml
        
    - name: ğŸ” Verify build
      run: |
        echo "Build verification:"
        ls -la _site/
        echo "Total files: $(find _site -type f | wc -l)"
        echo "Site size: $(du -sh _site/)"
        
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        
    - name: â˜ï¸ Setup Google Cloud SDK  
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: ğŸš€ Deploy to GCS (unified sync)
      run: |
        echo "ğŸš€ Deploying Jekyll site to GCS with unified approach..."
        
        # Debug: Check if _site directory exists and has content
        echo "ğŸ” Checking _site directory:"
        ls -la _site/ || echo "âŒ _site directory not found"
        echo "ğŸ“ _site contents:"
        find _site -type f | head -10 || echo "âŒ No files in _site"
        
        # Check authentication
        echo "ğŸ” Testing authentication:"
        gcloud auth list
        
        # Check GCS bucket access with more verbose logging
        echo "ğŸ” Testing GCS bucket access:"
        gcloud storage ls gs://${{ env.GCS_BUCKET }}/ --verbosity=info || {
          echo "âŒ Cannot access GCS bucket"
          echo "Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "Bucket: ${{ env.GCS_BUCKET }}"
          exit 1
        }
        
        # Use gcloud storage for consistency and better performance
        echo "ğŸš€ Starting rsync to GCS..."
        gcloud storage rsync _site/ gs://${{ env.GCS_BUCKET }}/ \
          --recursive \
          --delete-unmatched-destination-objects \
          --exclude="admin/config.yml" \
          --exclude="*.log" \
          --verbosity=info
        
        echo "ğŸ“Š Deployment stats:"
        gcloud storage ls -l -r gs://${{ env.GCS_BUCKET }}/ | tail -1
        
    - name: ğŸ”§ Set content types and security headers
      run: |
        echo "ğŸ”§ Optimizing content delivery..."
        
        # HTML files - short cache for content updates
        gcloud storage objects update gs://${{ env.GCS_BUCKET }}/**/*.html \
          --content-type="text/html" \
          --cache-control="public,max-age=3600" \
          --custom-metadata="x-frame-options=DENY,x-content-type-options=nosniff,x-xss-protection=1; mode=block"
        
        # CSS/JS files - longer cache with versioning
        gcloud storage objects update gs://${{ env.GCS_BUCKET }}/**/*.css \
          --content-type="text/css" \
          --cache-control="public,max-age=86400"
        
        gcloud storage objects update gs://${{ env.GCS_BUCKET }}/**/*.js \
          --content-type="application/javascript" \
          --cache-control="public,max-age=86400"
        
        # Other assets - very long cache
        for ext in png jpg jpeg gif svg woff woff2; do
          gcloud storage objects update "gs://${{ env.GCS_BUCKET }}/**/*.$ext" \
            --cache-control="public,max-age=31536000" 2>/dev/null || true
        done
          
        # Secure admin directory
        gcloud storage objects update gs://${{ env.GCS_BUCKET }}/admin/** \
          --cache-control="no-cache,no-store,must-revalidate" \
          --custom-metadata="x-frame-options=DENY" 2>/dev/null || true
        
    - name: ğŸ”„ Invalidate CDN cache
      run: |
        echo "ğŸ”„ Invalidating CDN cache globally..."
        gcloud compute url-maps invalidate-cdn-cache ${{ env.CDN_LB_NAME }} \
          --path="/*" \
          --async
        
    - name: ğŸ“‹ Deployment summary
      run: |
        echo "âœ… Perfect deployment completed!"
        echo ""
        echo "ğŸ“Š Deployment Summary:"
        echo "ğŸŒ Site: https://itsdanmanole.com"
        echo "â° Deployed: $(date)"
        echo "ğŸ”’ Security: Headers applied, Admin secured"
        echo "âš¡ CDN: Cache invalidated globally"
        echo "ğŸ¯ Status: Production ready"
        
    - name: ğŸ”” Notify on success
      if: success()
      run: |
        echo "ğŸ‰ Deployment successful! Site is live at https://itsdanmanole.com"
        
    - name: ğŸš¨ Notify on failure  
      if: failure()
      run: |
        echo "âŒ Deployment failed! Check logs above for details."
        exit 1